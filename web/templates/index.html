<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AILINKER</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Socket.io for future ESP32 hooks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <div id="app">
        <h1>[[ message ]]</h1>

        <div class="container">
            <!-- Left Panel: Device Status -->
            <div class="left-panel">
                <h2>è®¾å¤‡çŠ¶æ€ (Device Status)</h2>
                <div class="status-card">
                    <div class="device-status">
                        <div class="status-indicator">
                            <span class="status-dot" :class="{ 'online': deviceStatus }"></span>
                            <span class="status-text">[[ deviceStatus ? 'åœ¨çº¿' : 'ç¦»çº¿' ]]</span>
                        </div>
                        <div class="device-name">
                            <span class="label">è®¾å¤‡ï¼š</span>
                            <span class="value">[[ deviceName ]]</span>
                        </div>
                    </div>
                </div>

                <h2>å‚æ•°è®¾ç½® (Settings)</h2>
                <div class="status-card">
                    <p>å‚æ•°è®¾ç½®åŒºåŸŸ</p>
                </div>
            </div>

            <!-- Right Panel: Chat -->
            <div class="right-panel">
                <h2>èŠå¤©è®°å½• (Chat History)</h2>
                <div class="chat-container">
                    <div v-for="(msg, index) in messages" :key="index" class="chat-message">
                        [[ msg ]]
                    </div>
                </div>

                <input type="text" v-model="userMessage" @keyup.enter="sendMessage" placeholder="Type a message...">
                <button @click="sendMessage">Send</button>
            </div>
        </div>

        <!-- Emotion Control Buttons -->
        <h2>å‘é€æƒ…ç»ª (Send Emotion)</h2>
        <button @click="sendEmotion('HAPPY')">ğŸ˜Š Happy</button>
        <button @click="sendEmotion('SAD')">ğŸ˜¢ Sad</button>
        <button @click="sendEmotion('NEUTRAL')">ğŸ˜ Neutral</button>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            delimiters: ['[[', ']]'],  // Avoids Jinja2 conflicts
            data() {
                return {
                    message: "AILINKER is live!",
                    messages: [],
                    deviceStatus: false,
                    deviceName: 'åŠ è½½ä¸­...',  // Loading...
                    userMessage: '',
                    websocketConnected: false,
                    ws: null  // WebSocket instance
                };
            },
            methods: {
                // Fetch device info from Flask API (Original ESP32 Behavior)
                async fetchDeviceInfo() {
                    try {
                        const response = await fetch('/api/device/info');
                        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                        const data = await response.json();
                        this.deviceName = data.name;
                        this.deviceStatus = data.status;
                    } catch (error) {
                        console.error('âŒ è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
                        this.deviceStatus = false; // Assume offline if fetch fails
                    }
                },

                // Send chat message to Flask API
                async sendMessage() {
                    if (!this.userMessage.trim()) return;

                    try {
                        const response = await fetch('/api/chat', {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ message: this.userMessage })
                        });

                        const data = await response.json();
                        this.messages.push(`You: ${this.userMessage}`);
                        this.messages.push(`AI: ${data.response}`);
                        this.userMessage = "";
                    } catch (error) {
                        console.error("âŒ Chat Error:", error);
                    }
                },

                // Send emotion to ESP32 via WebSocket
                sendEmotion(emotion) {
                    if (!this.websocketConnected) {
                        console.warn("âš ï¸ WebSocket not connected!");
                        return;
                    }
                    this.ws.emit("eye_animation", { emotion: emotion });
                    console.log(`ğŸ“¡ Sent emotion: ${emotion}`);
                },

                // Initialize WebSocket (For Eye Animation Hook - Future)
                setupWebSocket() {
                    let wsUrl = `ws://${window.location.hostname}:8090/ws/eyes`;
                    console.log(`ğŸŸ¢ Connecting WebSocket: ${wsUrl}`);

                    this.ws = io(wsUrl);

                    this.ws.on("connect", () => {
                        console.log("ğŸŸ¢ WebSocket Connected!");
                        this.websocketConnected = true;
                    });

                    this.ws.on("disconnect", () => {
                        console.log("ğŸ”´ WebSocket Disconnected!");
                        this.websocketConnected = false;
                    });

                    this.ws.on("eye_animation", (data) => {
                        console.log("ğŸ‘€ Eye Animation Received:", data);
                    });

                    this.ws.on("connect_error", (error) => {
                        console.error("âŒ WebSocket Connection Error:", error);
                    });
                }
            },
            mounted() {
                this.fetchDeviceInfo();
                setInterval(this.fetchDeviceInfo, 5000); // Refresh device status every 5 seconds
                this.setupWebSocket(); // Initialize WebSocket for future hooks
            }
        }).mount('#app');
    </script>
</body>
</html>
